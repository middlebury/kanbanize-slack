#!/usr/bin/env php
<?php

require_once(dirname(__FILE__)."/../config.php");
require_once(dirname(__FILE__)."/../lib/KanbanizeActivityStream.php");
require_once(dirname(__FILE__)."/../lib/SlackRouter.php");
require_once(dirname(__FILE__)."/../lib/EverythingSlackDestination.php");
require_once(dirname(__FILE__)."/../lib/KanbanizeSlackFormatter.php");

date_default_timezone_set("UTC");
if (!defined("KANBANIZE_API_KEY") || !strlen(KANBANIZE_API_KEY)) {
  throw new Exception("KANBANIZE_API_KEY must be defined in config.php");
}
if (!defined("KANBANIZE_SUBDOMAIN") || !strlen(KANBANIZE_SUBDOMAIN)) {
  throw new Exception("KANBANIZE_SUBDOMAIN must be defined in config.php");
}
if (!defined("SLACK_URL") || !strlen(SLACK_URL)) {
  throw new Exception("SLACK_URL must be defined in config.php");
}
if (!defined("SLACK_CHANNEL") || !strlen(SLACK_CHANNEL)) {
  throw new Exception("SLACK_CHANNEL must be defined in config.php");
}

$kanbanize = new KanbanizeActivityStream(KANBANIZE_SUBDOMAIN, KANBANIZE_API_KEY);
$activities = $kanbanize->get_new_activity_for_board(2);

$groups = array();
foreach ($activities as $item) {
  if (empty($item['taskid'])) {
    $groups['other'][] = $item;
  } else {
    $groups[$item['taskid']][] = $item;
  }
}

$slack = new SlackRouter(SLACK_URL);
$slack->add_destination(new EverythingSlackDestination(SLACK_CHANNEL));
$slack->add_formatter(new KanbanizeSlackFormatter('Kanbanize', 'https://lh5.ggpht.com/aoUf1ZvpVeACwH2TBy0nP_Ipv53PtVnU42vCuutBDqCKcnfp5j78wUfBm41zix88_BM=w300'));
$slack->route_activities($groups);
